---
/**
 * Admin Dashboard
 * Overview of store performance and quick stats
 */
import AdminLayout from '@/components/admin/AdminLayout.astro';
import { createServerSupabase } from '@/lib/supabase';

const supabase = createServerSupabase(Astro.cookies);

// Fetch summary stats
const { data: orders } = await supabase
  .from('orders')
  .select('id, status, payment_status, total, created_at');

const { count: productCount } = await supabase
  .from('products')
  .select('*', { count: 'exact', head: true });

const { count: reviewCount } = await supabase
  .from('reviews')
  .select('*', { count: 'exact', head: true });

const { count: couponCount } = await supabase
  .from('coupons')
  .select('*', { count: 'exact', head: true });

// Calculate stats
const totalOrders = orders?.length || 0;
const pendingOrders = orders?.filter(o => o.status === 'pending' || o.status === 'processing').length || 0;
const paidOrders = orders?.filter(o => o.payment_status === 'paid').length || 0;
const totalRevenue = orders?.filter(o => o.payment_status === 'paid').reduce((sum, o) => sum + Number(o.total), 0) || 0;

// Recent orders (last 5)
const recentOrders = orders?.sort((a, b) => 
  new Date(b.created_at).getTime() - new Date(a.created_at).getTime()
).slice(0, 5) || [];

function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount);
}

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}
---

<AdminLayout title="Dashboard" currentPage="dashboard">
  <!-- Stats Grid -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon blue">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16.5 9.4l-9-5.19M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{totalOrders}</span>
        <span class="stat-label">Total Orders</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon amber">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <polyline points="12 6 12 12 16 14" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{pendingOrders}</span>
        <span class="stat-label">Pending Orders</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon green">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{formatCurrency(totalRevenue)}</span>
        <span class="stat-label">Total Revenue</span>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon purple">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
          <polyline points="22 4 12 14.01 9 11.01" />
        </svg>
      </div>
      <div class="stat-content">
        <span class="stat-value">{paidOrders}</span>
        <span class="stat-label">Paid Orders</span>
      </div>
    </div>
  </div>

  <!-- Quick Links -->
  <div class="section-title">Quick Actions</div>
  <div class="quick-links">
    <a href="/admin/orders/" class="quick-link">
      <span class="quick-link-icon">üì¶</span>
      <span>Manage Orders ({totalOrders})</span>
    </a>
    <a href="/admin/coupons/" class="quick-link">
      <span class="quick-link-icon">üè∑Ô∏è</span>
      <span>Manage Coupons ({couponCount || 0})</span>
    </a>
    <a href="/admin/reviews/" class="quick-link">
      <span class="quick-link-icon">‚≠ê</span>
      <span>Manage Reviews ({reviewCount || 0})</span>
    </a>
  </div>

  <!-- Recent Orders -->
  {recentOrders.length > 0 && (
    <div class="section-title">Recent Orders</div>
    <div class="recent-orders">
      <table class="orders-table">
        <thead>
          <tr>
            <th>Order</th>
            <th>Status</th>
            <th>Payment</th>
            <th>Total</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody>
          {recentOrders.map((order: any) => (
            <tr>
              <td>
                <a href={`/admin/orders/?search=${order.id}`} class="order-link">
                  {order.id.slice(0, 8)}...
                </a>
              </td>
              <td>
                <span class={`status-badge ${order.status}`}>{order.status}</span>
              </td>
              <td>
                <span class={`status-badge ${order.payment_status}`}>{order.payment_status}</span>
              </td>
              <td>{formatCurrency(order.total)}</td>
              <td>{formatDate(order.created_at)}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  )}
</AdminLayout>

<style>
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: #fff;
    border-radius: 0.75rem;
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .stat-icon {
    width: 3rem;
    height: 3rem;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .stat-icon svg {
    width: 1.5rem;
    height: 1.5rem;
  }

  .stat-icon.blue {
    background: #dbeafe;
    color: #2563eb;
  }

  .stat-icon.amber {
    background: #fef3c7;
    color: #d97706;
  }

  .stat-icon.green {
    background: #dcfce7;
    color: #16a34a;
  }

  .stat-icon.purple {
    background: #f3e8ff;
    color: #9333ea;
  }

  .stat-content {
    display: flex;
    flex-direction: column;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
  }

  .stat-label {
    font-size: 0.85rem;
    color: #64748b;
  }

  .section-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 1rem;
  }

  .quick-links {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .quick-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: #fff;
    border-radius: 0.5rem;
    text-decoration: none;
    color: #1e293b;
    font-size: 0.9rem;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    transition: all 0.15s;
  }

  .quick-link:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-1px);
  }

  .quick-link-icon {
    font-size: 1.25rem;
  }

  .recent-orders {
    background: #fff;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .orders-table {
    width: 100%;
    border-collapse: collapse;
  }

  .orders-table th,
  .orders-table td {
    padding: 0.875rem 1rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }

  .orders-table th {
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    background: #f8fafc;
  }

  .orders-table td {
    font-size: 0.9rem;
    color: #334155;
  }

  .order-link {
    color: #2563eb;
    text-decoration: none;
    font-family: monospace;
  }

  .order-link:hover {
    text-decoration: underline;
  }

  .status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: capitalize;
  }

  .status-badge.pending { background: #fef3c7; color: #92400e; }
  .status-badge.processing { background: #dbeafe; color: #1e40af; }
  .status-badge.paid { background: #dcfce7; color: #166534; }
  .status-badge.unpaid { background: #fee2e2; color: #991b1b; }
  .status-badge.shipped { background: #f3e8ff; color: #7c3aed; }
  .status-badge.delivered { background: #dcfce7; color: #166534; }
  .status-badge.cancelled { background: #f1f5f9; color: #475569; }
</style>
