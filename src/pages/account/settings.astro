---
/**
 * Account Settings Page
 * Profile editing, password change, email preferences, delete account
 */
import BaseLayout from '@/components/layout/BaseLayout.astro';
import AccountLayout from '@/components/account/AccountLayout.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import { siteSettings } from '@/config/site-settings';
import { createServerSupabase } from '@/lib/supabase';

// Get user session
const supabase = createServerSupabase(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user) {
  return Astro.redirect('/auth/login?redirect=/account/settings/');
}

// Get user info
const fullName = user.user_metadata?.full_name || '';
const userEmail = user.email || '';
const newsletter = user.user_metadata?.newsletter ?? true;

// SEO Meta
const meta = {
  title: `Account Settings | ${siteSettings.siteName}`,
  description: 'Manage your profile, password, and account preferences.',
  noindex: true,
};

// Breadcrumb items
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'My Account', href: '/account/' },
  { label: 'Settings', href: '/account/settings/' },
];
---

<BaseLayout {meta}>
  <div class="bg-brand-light min-h-screen py-8">
    <div class="container mx-auto px-4">
      <!-- Breadcrumb -->
      <Breadcrumb items={breadcrumbItems} />

      <!-- Account Layout with Sidebar -->
      <AccountLayout user={user} currentPage="settings">
        <!-- Page Header -->
        <div class="account-section-header" style="margin-bottom: 1.5rem;">
          <h1 class="text-2xl font-serif text-brand-dark">Account Settings</h1>
          <p class="text-sm text-gray-500 mt-1">Manage your profile and preferences</p>
        </div>

        <!-- Profile Section -->
        <div class="settings-card" id="profile-section">
          <div class="settings-card-header">
            <div class="settings-card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
            </div>
            <div>
              <h2 class="settings-card-title">Personal Information</h2>
              <p class="settings-card-subtitle">Update your name and email address</p>
            </div>
          </div>

          <form id="profile-form" class="settings-form">
            <div class="settings-form-grid">
              <div class="form-group">
                <label for="full_name" class="form-label">Full Name</label>
                <input
                  type="text"
                  id="full_name"
                  name="full_name"
                  value={fullName}
                  placeholder="Enter your full name"
                  class="form-input"
                />
              </div>
              <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  value={userEmail}
                  placeholder="Enter your email"
                  class="form-input"
                />
                <p class="form-hint">Changing your email will require verification.</p>
              </div>
            </div>

            <!-- Messages -->
            <div id="profile-message" class="settings-message hidden"></div>

            <div class="settings-form-actions">
              <button type="submit" class="settings-save-btn" id="profile-submit">
                <span class="btn-text">Save Changes</span>
                <span class="btn-loading hidden">
                  <span class="auth-spinner"></span>
                  Saving...
                </span>
              </button>
            </div>
          </form>
        </div>

        <!-- Password Section -->
        <div class="settings-card" id="password-section">
          <div class="settings-card-header">
            <div class="settings-card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
              </svg>
            </div>
            <div>
              <h2 class="settings-card-title">Change Password</h2>
              <p class="settings-card-subtitle">Update your password to keep your account secure</p>
            </div>
          </div>

          <form id="password-form" class="settings-form">
            <div class="settings-form-stack">
              <div class="form-group">
                <label for="new_password" class="form-label">New Password</label>
                <div class="password-input-wrapper">
                  <input
                    type="password"
                    id="new_password"
                    name="new_password"
                    placeholder="Enter new password"
                    class="form-input"
                    minlength="6"
                    autocomplete="new-password"
                  />
                  <button type="button" class="password-toggle" data-target="new_password" aria-label="Toggle password visibility">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 eye-open">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 eye-closed hidden">
                      <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                      <line x1="1" y1="1" x2="23" y2="23"/>
                    </svg>
                  </button>
                </div>
                <p class="form-hint">Must be at least 6 characters.</p>
              </div>
              <div class="form-group">
                <label for="confirm_password" class="form-label">Confirm New Password</label>
                <div class="password-input-wrapper">
                  <input
                    type="password"
                    id="confirm_password"
                    name="confirm_password"
                    placeholder="Confirm new password"
                    class="form-input"
                    minlength="6"
                    autocomplete="new-password"
                  />
                  <button type="button" class="password-toggle" data-target="confirm_password" aria-label="Toggle password visibility">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 eye-open">
                      <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                      <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 eye-closed hidden">
                      <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                      <line x1="1" y1="1" x2="23" y2="23"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Messages -->
            <div id="password-message" class="settings-message hidden"></div>

            <div class="settings-form-actions">
              <button type="submit" class="settings-save-btn" id="password-submit">
                <span class="btn-text">Update Password</span>
                <span class="btn-loading hidden">
                  <span class="auth-spinner"></span>
                  Updating...
                </span>
              </button>
            </div>
          </form>
        </div>

        <!-- Email Preferences Section -->
        <div class="settings-card" id="preferences-section">
          <div class="settings-card-header">
            <div class="settings-card-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
            </div>
            <div>
              <h2 class="settings-card-title">Email Preferences</h2>
              <p class="settings-card-subtitle">Manage your email notifications</p>
            </div>
          </div>

          <div class="settings-preference-list">
            <div class="settings-preference-item">
              <div class="settings-preference-info">
                <h3 class="settings-preference-label">Newsletter & Promotions</h3>
                <p class="settings-preference-description">
                  Receive updates about new products, special offers, and photography tips.
                </p>
              </div>
              <label class="settings-toggle" for="newsletter-toggle">
                <input
                  type="checkbox"
                  id="newsletter-toggle"
                  checked={newsletter}
                />
                <span class="settings-toggle-slider"></span>
              </label>
            </div>

            <div class="settings-preference-item">
              <div class="settings-preference-info">
                <h3 class="settings-preference-label">Order Updates</h3>
                <p class="settings-preference-description">
                  Notifications about your order status, shipping, and delivery.
                </p>
              </div>
              <label class="settings-toggle disabled">
                <input type="checkbox" checked disabled />
                <span class="settings-toggle-slider"></span>
                <span class="settings-toggle-required">Required</span>
              </label>
            </div>
          </div>

          <!-- Messages -->
          <div id="preferences-message" class="settings-message hidden" style="margin-top: 1rem;"></div>
        </div>

        <!-- Danger Zone -->
        <div class="settings-card danger" id="danger-section">
          <div class="settings-card-header">
            <div class="settings-card-icon danger">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                <line x1="12" y1="9" x2="12" y2="13"/>
                <line x1="12" y1="17" x2="12.01" y2="17"/>
              </svg>
            </div>
            <div>
              <h2 class="settings-card-title danger">Danger Zone</h2>
              <p class="settings-card-subtitle">Irreversible account actions</p>
            </div>
          </div>

          <div class="settings-danger-content">
            <div class="settings-danger-item">
              <div>
                <h3 class="settings-danger-label">Delete Account</h3>
                <p class="settings-danger-description">
                  Permanently delete your account and all associated data. This action cannot be undone.
                </p>
              </div>
              <button type="button" class="settings-danger-btn" id="delete-account-btn">
                Delete Account
              </button>
            </div>
          </div>

          <!-- Delete Confirmation Modal -->
          <div id="delete-modal" class="settings-modal-overlay hidden">
            <div class="settings-modal">
              <div class="settings-modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-8 h-8 text-red-500">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                  <line x1="12" y1="9" x2="12" y2="13"/>
                  <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
              </div>
              <h3 class="settings-modal-title">Delete Your Account?</h3>
              <p class="settings-modal-description">
                This will permanently delete your account, order history, saved addresses, and all associated data. This action <strong>cannot be undone</strong>.
              </p>
              <p class="settings-modal-confirm-text">
                Type <strong>DELETE</strong> to confirm:
              </p>
              <input
                type="text"
                id="delete-confirm-input"
                class="form-input"
                placeholder="Type DELETE"
                autocomplete="off"
              />
              <div id="delete-message" class="settings-message hidden" style="margin-top: 0.75rem;"></div>
              <div class="settings-modal-actions">
                <button type="button" class="settings-modal-cancel" id="delete-cancel-btn">
                  Cancel
                </button>
                <button type="button" class="settings-modal-confirm" id="delete-confirm-btn" disabled>
                  <span class="btn-text">Delete My Account</span>
                  <span class="btn-loading hidden">
                    <span class="auth-spinner"></span>
                    Deleting...
                  </span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Need Help Section -->
        <div class="account-help-card" style="margin-top: 2rem;">
          <div class="account-help-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </div>
          <div class="account-help-content">
            <h3 class="account-help-title">Need Help?</h3>
            <p class="account-help-description">
              Having trouble with your account settings? Our support team is here to help.
            </p>
          </div>
          <div class="account-help-actions">
            <a href={siteSettings.contact.whatsappUrl} target="_blank" rel="noopener noreferrer" class="account-help-btn whatsapp">
              <svg viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
              WhatsApp
            </a>
            <a href={`mailto:${siteSettings.contact.email}`} class="account-help-btn email">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              Email Us
            </a>
          </div>
        </div>
      </AccountLayout>
    </div>
  </div>
</BaseLayout>

<script>
  import { createClient } from '@/lib/supabase';

  const supabase = createClient();

  // ===========================================
  // Helpers
  // ===========================================

  function showMessage(elementId: string, message: string, type: 'success' | 'error') {
    const el = document.getElementById(elementId);
    if (!el) return;
    el.className = `settings-message ${type}`;
    el.textContent = message;
    el.classList.remove('hidden');
    // Auto-hide success messages
    if (type === 'success') {
      setTimeout(() => el.classList.add('hidden'), 5000);
    }
  }

  function hideMessage(elementId: string) {
    const el = document.getElementById(elementId);
    if (el) el.classList.add('hidden');
  }

  function setLoading(buttonId: string, loading: boolean) {
    const btn = document.getElementById(buttonId) as HTMLButtonElement | null;
    if (!btn) return;
    const textEl = btn.querySelector('.btn-text') as HTMLElement;
    const loadingEl = btn.querySelector('.btn-loading') as HTMLElement;
    if (loading) {
      btn.disabled = true;
      textEl?.classList.add('hidden');
      loadingEl?.classList.remove('hidden');
    } else {
      btn.disabled = false;
      textEl?.classList.remove('hidden');
      loadingEl?.classList.add('hidden');
    }
  }

  // ===========================================
  // Password Toggle
  // ===========================================

  document.querySelectorAll('.password-toggle').forEach((btn) => {
    btn.addEventListener('click', () => {
      const targetId = btn.getAttribute('data-target');
      if (!targetId) return;
      const input = document.getElementById(targetId) as HTMLInputElement;
      const eyeOpen = btn.querySelector('.eye-open');
      const eyeClosed = btn.querySelector('.eye-closed');
      if (input.type === 'password') {
        input.type = 'text';
        eyeOpen?.classList.add('hidden');
        eyeClosed?.classList.remove('hidden');
      } else {
        input.type = 'password';
        eyeOpen?.classList.remove('hidden');
        eyeClosed?.classList.add('hidden');
      }
    });
  });

  // ===========================================
  // Profile Form
  // ===========================================

  const profileForm = document.getElementById('profile-form') as HTMLFormElement;
  profileForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideMessage('profile-message');

    const fullName = (document.getElementById('full_name') as HTMLInputElement).value.trim();
    const email = (document.getElementById('email') as HTMLInputElement).value.trim();

    if (!fullName) {
      showMessage('profile-message', 'Please enter your full name.', 'error');
      return;
    }
    if (!email) {
      showMessage('profile-message', 'Please enter your email address.', 'error');
      return;
    }

    setLoading('profile-submit', true);

    try {
      // Update user metadata (full_name)
      const { error: metaError } = await supabase.auth.updateUser({
        data: { full_name: fullName },
      });
      if (metaError) throw metaError;

      // Update email if changed
      const { data: { user } } = await supabase.auth.getUser();
      if (user && email !== user.email) {
        const { error: emailError } = await supabase.auth.updateUser({ email });
        if (emailError) throw emailError;
        showMessage('profile-message', 'Profile updated. Please check your new email to confirm the change.', 'success');
      } else {
        showMessage('profile-message', 'Profile updated successfully.', 'success');
      }
    } catch (err: any) {
      showMessage('profile-message', err.message || 'Failed to update profile.', 'error');
    } finally {
      setLoading('profile-submit', false);
    }
  });

  // ===========================================
  // Password Form
  // ===========================================

  const passwordForm = document.getElementById('password-form') as HTMLFormElement;
  passwordForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideMessage('password-message');

    const newPassword = (document.getElementById('new_password') as HTMLInputElement).value;
    const confirmPassword = (document.getElementById('confirm_password') as HTMLInputElement).value;

    if (!newPassword || newPassword.length < 6) {
      showMessage('password-message', 'Password must be at least 6 characters.', 'error');
      return;
    }
    if (newPassword !== confirmPassword) {
      showMessage('password-message', 'Passwords do not match.', 'error');
      return;
    }

    setLoading('password-submit', true);

    try {
      const { error } = await supabase.auth.updateUser({ password: newPassword });
      if (error) throw error;

      showMessage('password-message', 'Password updated successfully.', 'success');
      // Clear fields
      (document.getElementById('new_password') as HTMLInputElement).value = '';
      (document.getElementById('confirm_password') as HTMLInputElement).value = '';
    } catch (err: any) {
      showMessage('password-message', err.message || 'Failed to update password.', 'error');
    } finally {
      setLoading('password-submit', false);
    }
  });

  // ===========================================
  // Newsletter Toggle
  // ===========================================

  const newsletterToggle = document.getElementById('newsletter-toggle') as HTMLInputElement;
  newsletterToggle?.addEventListener('change', async () => {
    hideMessage('preferences-message');
    const checked = newsletterToggle.checked;

    try {
      const { error } = await supabase.auth.updateUser({
        data: { newsletter: checked },
      });
      if (error) throw error;
      showMessage('preferences-message', checked ? 'Newsletter subscription enabled.' : 'Newsletter subscription disabled.', 'success');
    } catch (err: any) {
      // Revert toggle on error
      newsletterToggle.checked = !checked;
      showMessage('preferences-message', err.message || 'Failed to update preferences.', 'error');
    }
  });

  // ===========================================
  // Delete Account
  // ===========================================

  const deleteBtn = document.getElementById('delete-account-btn');
  const deleteModal = document.getElementById('delete-modal');
  const deleteCancelBtn = document.getElementById('delete-cancel-btn');
  const deleteConfirmBtn = document.getElementById('delete-confirm-btn');
  const deleteConfirmInput = document.getElementById('delete-confirm-input') as HTMLInputElement;

  deleteBtn?.addEventListener('click', () => {
    deleteModal?.classList.remove('hidden');
    deleteConfirmInput.value = '';
    (deleteConfirmBtn as HTMLButtonElement).disabled = true;
    hideMessage('delete-message');
  });

  deleteCancelBtn?.addEventListener('click', () => {
    deleteModal?.classList.add('hidden');
  });

  // Close modal on overlay click
  deleteModal?.addEventListener('click', (e) => {
    if (e.target === deleteModal) {
      deleteModal.classList.add('hidden');
    }
  });

  // Enable/disable confirm button based on input
  deleteConfirmInput?.addEventListener('input', () => {
    const confirmBtn = deleteConfirmBtn as HTMLButtonElement;
    confirmBtn.disabled = deleteConfirmInput.value.trim() !== 'DELETE';
  });

  // Handle delete confirmation
  deleteConfirmBtn?.addEventListener('click', async () => {
    if (deleteConfirmInput.value.trim() !== 'DELETE') return;

    hideMessage('delete-message');
    setLoading('delete-confirm-btn', true);

    try {
      // Note: Full account deletion typically requires a server-side API endpoint
      // with admin privileges. Here we sign out and show a message to contact support.
      // In production, implement a /api/account/delete endpoint.
      showMessage('delete-message',
        'Account deletion request submitted. Please contact our support team to complete this process. You will be signed out now.',
        'success'
      );

      // Sign out after short delay
      setTimeout(async () => {
        await supabase.auth.signOut();
        window.location.href = '/';
      }, 3000);
    } catch (err: any) {
      showMessage('delete-message', err.message || 'Failed to process deletion request.', 'error');
      setLoading('delete-confirm-btn', false);
    }
  });

  // Close modal on ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !deleteModal?.classList.contains('hidden')) {
      deleteModal?.classList.add('hidden');
    }
  });
</script>
