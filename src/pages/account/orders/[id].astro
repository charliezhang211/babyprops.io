---
/**
 * Order Detail Page
 * Displays full order details with status timeline, items, address, and payment summary
 */
import BaseLayout from '@/components/layout/BaseLayout.astro';
import AccountLayout from '@/components/account/AccountLayout.astro';
import Breadcrumb from '@/components/ui/Breadcrumb.astro';
import { siteSettings } from '@/config/site-settings';
import { createServerSupabase } from '@/lib/supabase';
import type { OrderItemRow, ShippingAddressSnapshot } from '@/lib/supabase';
import { getCollection } from 'astro:content';

// Get order ID from URL params
const { id } = Astro.params;

// Get user session
const supabase = createServerSupabase(Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

// Redirect to login if not authenticated
if (!user) {
  return Astro.redirect(`/auth/login?redirect=/account/orders/${id}/`);
}

// Fetch order by ID
const { data: order, error: orderError } = await supabase
  .from('orders')
  .select('*')
  .eq('id', id)
  .eq('user_id', user.id)
  .single();

// Redirect to orders list if order not found or doesn't belong to user
if (!order || orderError) {
  return Astro.redirect('/account/orders/');
}

// Fetch order items
const { data: items } = await supabase
  .from('order_items')
  .select('*')
  .eq('order_id', order.id)
  .order('created_at', { ascending: true });

const orderItems: OrderItemRow[] = items || [];

// Build slug-to-category map â€” only fetch products matching order item slugs
const itemSlugs = orderItems.map(i => i.product_slug);
const matchedProducts = await getCollection('products', ({ data }) => itemSlugs.includes(data.slug));
const slugToCategoryMap = new Map(matchedProducts.map(p => [p.data.slug, p.data.category]));

// Helper function to get status badge color
function getStatusColor(status: string): string {
  const colors: Record<string, string> = {
    pending: 'bg-amber-100 text-amber-700',
    paid: 'bg-blue-100 text-blue-700',
    processing: 'bg-blue-100 text-blue-700',
    shipped: 'bg-purple-100 text-purple-700',
    delivered: 'bg-brand-accent/30 text-green-700',
    cancelled: 'bg-gray-100 text-gray-700',
    refunded: 'bg-red-100 text-red-700',
  };
  return colors[status] || 'bg-gray-100 text-gray-700';
}

// Helper function to format status
function formatStatus(status: string): string {
  return status.charAt(0).toUpperCase() + status.slice(1);
}

// Helper function to format date
function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}

// Helper function to format date with time
function formatDateTime(dateString: string): string {
  return new Date(dateString).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
}

// Helper function to format currency
function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(amount);
}

// Order status timeline steps
const timelineSteps = [
  {
    id: 'pending',
    label: 'Order Placed',
    description: 'Your order has been received',
    matchStatuses: ['pending', 'paid', 'processing', 'shipped', 'delivered'],
    date: order.created_at,
  },
  {
    id: 'processing',
    label: 'Processing',
    description: 'We are preparing your items',
    matchStatuses: ['processing', 'shipped', 'delivered'],
    date: order.paid_at || null,
  },
  {
    id: 'shipped',
    label: 'Shipped',
    description: 'Your order is on the way',
    matchStatuses: ['shipped', 'delivered'],
    date: order.shipped_at || null,
  },
  {
    id: 'delivered',
    label: 'Delivered',
    description: 'Your order has been delivered',
    matchStatuses: ['delivered'],
    date: null,
  },
];

// Determine which steps are completed, current, or upcoming
function getStepState(step: typeof timelineSteps[0]): 'completed' | 'current' | 'upcoming' {
  const isCancelled = order.status === 'cancelled' || order.status === 'refunded';
  if (isCancelled) {
    // For cancelled/refunded, only "Order Placed" is completed
    if (step.id === 'pending') return 'completed';
    return 'upcoming';
  }

  // Map order status to the corresponding timeline step
  const statusToStep: Record<string, string> = {
    pending: 'pending',
    paid: 'processing',
    processing: 'processing',
    shipped: 'shipped',
    delivered: 'delivered',
  };
  const currentStepId = statusToStep[order.status] || 'pending';

  if (step.id === currentStepId) return 'current';

  const stepIndex = timelineSteps.findIndex(s => s.id === step.id);
  const currentIndex = timelineSteps.findIndex(s => s.id === currentStepId);

  if (stepIndex < currentIndex) return 'completed';
  return 'upcoming';
}

// Check if order is cancelled or refunded
const isCancelledOrRefunded = order.status === 'cancelled' || order.status === 'refunded';

// Parse shipping address
const address: ShippingAddressSnapshot = order.shipping_address as ShippingAddressSnapshot;

// SEO Meta
const meta = {
  title: `Order #${order.order_number} | ${siteSettings.siteName}`,
  description: 'View your order details and tracking information.',
  noindex: true,
};

// Breadcrumb items
const breadcrumbItems = [
  { label: 'Home', href: '/' },
  { label: 'My Account', href: '/account/' },
  { label: 'Order History', href: '/account/orders/' },
  { label: `#${order.order_number}`, href: `/account/orders/${order.id}/` },
];
---

<BaseLayout {meta}>
  <div class="bg-brand-light min-h-screen py-8">
    <div class="container mx-auto px-4">
      <!-- Breadcrumb -->
      <Breadcrumb items={breadcrumbItems} />

      <!-- Account Layout with Sidebar -->
      <AccountLayout user={user} currentPage="orders">
        <!-- Back Link -->
        <a href="/account/orders/" class="order-detail-back">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
          Back to Order History
        </a>

        <!-- Order Header -->
        <div class="order-detail-header">
          <div>
            <h1 class="order-detail-title">Order #{order.order_number}</h1>
            <p class="order-detail-date">Placed on {formatDateTime(order.created_at)}</p>
          </div>
          <span class={`account-order-status text-sm ${getStatusColor(order.status)}`}>
            {formatStatus(order.status)}
          </span>
        </div>

        <!-- Cancelled/Refunded Notice -->
        {isCancelledOrRefunded && (
          <div class="order-detail-notice">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 flex-shrink-0">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <div>
              <p class="font-medium">
                This order has been {order.status === 'cancelled' ? 'cancelled' : 'refunded'}.
              </p>
              {order.status === 'refunded' && (
                <p class="text-sm mt-1">
                  The refund has been processed and should appear in your account within 5-10 business days.
                </p>
              )}
            </div>
          </div>
        )}

        <!-- Order Status Timeline -->
        {!isCancelledOrRefunded && (
          <div class="order-detail-card">
            <h2 class="order-detail-card-title">Order Status</h2>
            <div class="order-timeline">
              {timelineSteps.map((step, index) => {
                const state = getStepState(step);
                return (
                  <div class={`order-timeline-step ${state}`}>
                    <div class="order-timeline-indicator">
                      <div class="order-timeline-dot">
                        {state === 'completed' ? (
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" class="w-3 h-3">
                            <polyline points="20 6 9 17 4 12"/>
                          </svg>
                        ) : state === 'current' ? (
                          <div class="order-timeline-pulse" />
                        ) : null}
                      </div>
                      {index < timelineSteps.length - 1 && (
                        <div class={`order-timeline-line ${state === 'completed' ? 'completed' : ''}`} />
                      )}
                    </div>
                    <div class="order-timeline-content">
                      <p class="order-timeline-label">{step.label}</p>
                      <p class="order-timeline-description">{step.description}</p>
                      {step.date && state !== 'upcoming' && (
                        <p class="order-timeline-date">{formatDate(step.date)}</p>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        <!-- Tracking Info (if shipped) -->
        {(order.status === 'shipped' || order.status === 'delivered') && order.internal_note && (
          <div class="order-detail-card">
            <h2 class="order-detail-card-title">Tracking Information</h2>
            <div class="order-tracking-info">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5 text-brand-dark flex-shrink-0">
                <rect x="1" y="3" width="15" height="13"/>
                <polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
                <circle cx="5.5" cy="18.5" r="2.5"/>
                <circle cx="18.5" cy="18.5" r="2.5"/>
              </svg>
              <div>
                <p class="text-sm text-gray-600">{order.internal_note}</p>
              </div>
            </div>
          </div>
        )}

        <!-- Order Items -->
        <div class="order-detail-card">
          <h2 class="order-detail-card-title">
            Items ({orderItems.length})
          </h2>
          <div class="order-detail-items">
            {orderItems.map((item) => (
              <div class="order-detail-item">
                <div class="order-detail-item-image">
                  {item.image ? (
                    <img
                      src={item.image}
                      alt={item.name}
                      class="w-full h-full object-cover"
                      loading="lazy"
                    />
                  ) : (
                    <div class="order-detail-item-placeholder">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                        <circle cx="8.5" cy="8.5" r="1.5"/>
                        <path d="M21 15l-5-5L5 21"/>
                      </svg>
                    </div>
                  )}
                </div>
                <div class="order-detail-item-info">
                  <a href={`/${slugToCategoryMap.get(item.product_slug) || 'products'}/${item.product_slug}/`} class="order-detail-item-name">
                    {item.name}
                  </a>
                  <div class="order-detail-item-meta">
                    <span>SKU: {item.sku}</span>
                    {item.variant && <span>Variant: {item.variant}</span>}
                    {item.color && <span>Color: {item.color}</span>}
                    {item.size && <span>Size: {item.size}</span>}
                  </div>
                  <div class="order-detail-item-qty">
                    Qty: {item.quantity}
                  </div>
                </div>
                <div class="order-detail-item-price">
                  <span class="order-detail-item-line-total">{formatCurrency(item.line_total)}</span>
                  {item.quantity > 1 && (
                    <span class="order-detail-item-unit-price">
                      {formatCurrency(item.unit_price)} each
                    </span>
                  )}
                </div>
              </div>
            ))}
          </div>
        </div>

        <!-- Two Column: Shipping Address + Payment Summary -->
        <div class="order-detail-grid">
          <!-- Shipping Address -->
          <div class="order-detail-card">
            <h2 class="order-detail-card-title">Shipping Address</h2>
            <div class="order-detail-address">
              <p class="font-medium text-brand-dark">{address.full_name}</p>
              <p>{address.address_line1}</p>
              {address.address_line2 && <p>{address.address_line2}</p>}
              <p>{address.city}, {address.state} {address.postal_code}</p>
              <p>{address.country}</p>
              {address.phone && (
                <p class="mt-2 text-brand-dark">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 inline mr-1">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                  </svg>
                  {address.phone}
                </p>
              )}
              <p class="mt-1">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 inline mr-1">
                  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                  <polyline points="22,6 12,13 2,6"/>
                </svg>
                {address.email || order.email}
              </p>
            </div>
          </div>

          <!-- Payment Info -->
          <div class="order-detail-card">
            <h2 class="order-detail-card-title">Payment Information</h2>
            <div class="order-detail-payment">
              <div class="order-detail-payment-method">
                <svg viewBox="0 0 24 24" fill="currentColor" class="w-8 h-5 text-blue-600 flex-shrink-0">
                  <path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/>
                </svg>
                <div>
                  <p class="font-medium text-brand-dark">PayPal</p>
                  {order.paypal_order_id && (
                    <p class="text-xs text-gray-400 mt-0.5">
                      Transaction: {order.paypal_order_id.slice(0, 18)}...
                    </p>
                  )}
                </div>
              </div>
              <div class="order-detail-payment-status">
                <span class="text-sm text-gray-600">Payment Status:</span>
                <span class={`account-order-status text-xs ml-2 ${
                  order.payment_status === 'paid' ? 'bg-brand-accent/30 text-green-700' :
                  order.payment_status === 'refunded' ? 'bg-red-100 text-red-700' :
                  'bg-amber-100 text-amber-700'
                }`}>
                  {formatStatus(order.payment_status)}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Order Summary (Pricing) -->
        <div class="order-detail-card">
          <h2 class="order-detail-card-title">Order Summary</h2>
          <div class="order-detail-summary">
            <div class="order-detail-summary-row">
              <span>Subtotal ({orderItems.length} item{orderItems.length !== 1 ? 's' : ''})</span>
              <span>{formatCurrency(order.subtotal)}</span>
            </div>
            <div class="order-detail-summary-row">
              <span>Shipping</span>
              <span>{order.shipping_cost > 0 ? formatCurrency(order.shipping_cost) : 'FREE'}</span>
            </div>
            {order.tax > 0 && (
              <div class="order-detail-summary-row">
                <span>Tax</span>
                <span>{formatCurrency(order.tax)}</span>
              </div>
            )}
            {order.discount > 0 && (
              <div class="order-detail-summary-row discount">
                <span>Discount</span>
                <span>-{formatCurrency(order.discount)}</span>
              </div>
            )}
            <div class="order-detail-summary-total">
              <span>Total</span>
              <span>{formatCurrency(order.total)}</span>
            </div>
          </div>
        </div>

        <!-- Customer Note (if any) -->
        {order.customer_note && (
          <div class="order-detail-card">
            <h2 class="order-detail-card-title">Order Note</h2>
            <p class="text-sm text-gray-600 leading-relaxed">{order.customer_note}</p>
          </div>
        )}

        <!-- Need Help Section -->
        <div class="account-help-card mt-8">
          <div class="account-help-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </div>
          <div class="account-help-content">
            <h3 class="account-help-title">Need Help with This Order?</h3>
            <p class="account-help-description">
              Contact us for order inquiries, tracking updates, or any questions. Please include your order number <strong>#{order.order_number}</strong>.
            </p>
          </div>
          <div class="account-help-actions">
            <a
              href={`${siteSettings.contact.whatsappUrl}?text=${encodeURIComponent(`Hi, I need help with order #${order.order_number}`)}`}
              target="_blank"
              rel="noopener noreferrer"
              class="account-help-btn whatsapp"
            >
              <svg viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
              </svg>
              WhatsApp
            </a>
            <a href={`mailto:${siteSettings.contact.email}?subject=Order%20%23${order.order_number}%20Inquiry`} class="account-help-btn email">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                <polyline points="22,6 12,13 2,6"/>
              </svg>
              Email Us
            </a>
          </div>
        </div>
      </AccountLayout>
    </div>
  </div>
</BaseLayout>
