---
// ğŸ“ src/components/pdp/RelatedProducts.astro
// ç›¸å…³äº§å“æ¨èç»„ä»¶ - "Complete the Look"

import { getCollection, type CollectionEntry } from 'astro:content';
import ProductCard from '@/components/plp/ProductCard.astro';

interface Props {
  currentProduct: CollectionEntry<'products'>;
  limit?: number;
  title?: string;
  class?: string;
}

const {
  currentProduct,
  limit = 8,
  title = 'Complete the Look',
  class: className = '',
} = Astro.props;

const currentData = currentProduct.data;

/**
 * è·å–æ¨èäº§å“
 * ä¼˜å…ˆçº§:
 * 1. æ‰‹åŠ¨æŒ‡å®šçš„ related_products
 * 2. åŒè‰²ç³»äº§å“ (ç›¸åŒ color_family)
 * 3. åŒåˆ†ç±»äº§å“ (ç›¸åŒ category)
 */
async function getRecommendedProducts(): Promise<CollectionEntry<'products'>[]> {
  // è·å–æ‰€æœ‰äº§å“ (æ’é™¤å½“å‰äº§å“ï¼Œåªä¿ç•™æœ‰åº“å­˜)
  const allProducts = await getCollection('products', ({ id, data }) => {
    return id !== currentProduct.id && data.in_stock;
  });

  const recommended: CollectionEntry<'products'>[] = [];

  // 1. æ‰‹åŠ¨æŒ‡å®šçš„ç›¸å…³äº§å“ (å¦‚æœæœ‰)
  if (currentData.related_products && currentData.related_products.length > 0) {
    const manualRelated = allProducts.filter((p) =>
      currentData.related_products?.includes(p.data.slug)
    );
    recommended.push(...manualRelated);
  }

  // 2. åŒè‰²ç³»äº§å“ (å¦‚æœå½“å‰äº§å“æœ‰ color_family)
  if (currentData.color_family && recommended.length < limit) {
    const sameColorFamily = allProducts.filter(
      (p) =>
        p.data.color_family === currentData.color_family &&
        !recommended.some((r) => r.id === p.id)
    );
    recommended.push(...sameColorFamily);
  }

  // 3. åŒåˆ†ç±»äº§å“
  if (recommended.length < limit) {
    const sameCategory = allProducts.filter(
      (p) =>
        p.data.category === currentData.category &&
        !recommended.some((r) => r.id === p.id)
    );
    recommended.push(...sameCategory);
  }

  // 4. å¦‚æœè¿˜ä¸å¤Ÿï¼Œæ·»åŠ å…¶ä»–æ–°å“æˆ–ç²¾é€‰äº§å“
  if (recommended.length < limit) {
    const featuredOrNew = allProducts.filter(
      (p) =>
        (p.data.is_featured || p.data.is_new) &&
        !recommended.some((r) => r.id === p.id)
    );
    recommended.push(...featuredOrNew);
  }

  // 5. å¦‚æœè¿˜ä¸å¤Ÿï¼Œæ·»åŠ ä»»æ„å…¶ä»–äº§å“
  if (recommended.length < limit) {
    const others = allProducts.filter(
      (p) => !recommended.some((r) => r.id === p.id)
    );
    recommended.push(...others);
  }

  // é™åˆ¶æ•°é‡å¹¶è¿”å›
  return recommended.slice(0, limit);
}

const relatedProducts = await getRecommendedProducts();

// å¦‚æœæ²¡æœ‰ç›¸å…³äº§å“ï¼Œä¸æ¸²æŸ“ç»„ä»¶
if (relatedProducts.length === 0) {
  return null;
}
---

<section
  class:list={['py-12 bg-brand-light/30', className]}
  data-component="related-products"
  aria-labelledby="related-products-title"
>
  <div class="container mx-auto px-4">
    {/* æ ‡é¢˜ */}
    <div class="text-center mb-8">
      <h2
        id="related-products-title"
        class="text-3xl md:text-4xl font-serif text-brand-dark mb-2"
      >
        {title}
      </h2>
      <p class="text-gray-600 max-w-2xl mx-auto">
        Explore complementary props to create the perfect photoshoot setup
      </p>
    </div>

    {/* äº§å“ç½‘æ ¼ */}
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
      {relatedProducts.map((product, index) => (
        <ProductCard
          product={product}
          loading={index < 4 ? 'eager' : 'lazy'}
          showQuickAdd={false}
        />
      ))}
    </div>

    {/* "View All" æŒ‰é’® (å¯é€‰) */}
    {currentData.category && (
      <div class="text-center mt-8">
        <a
          href={`/shop/${currentData.category}`}
          class="inline-flex items-center gap-2 px-6 py-3 text-brand-dark border-2 border-brand rounded-full hover:bg-brand hover:text-white transition-colors font-medium"
        >
          View All {currentData.category.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
          <svg
            class="w-4 h-4"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            />
          </svg>
        </a>
      </div>
    )}
  </div>
</section>

<style>
  /* æ·¡å…¥åŠ¨ç”» (å¯é€‰) */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  [data-component="related-products"] {
    animation: fadeInUp 0.6s ease-out;
  }
</style>
